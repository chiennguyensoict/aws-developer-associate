# KMS

- Regional and a Public Service.
- Each region is isolated when using KMS.
- It's a publich service and occupies AWS public zone.
- It can be connected to by anything with permission in the public zone.

Create, store, and manage keys.

- Can handle both symmetric and asymmetric keys.
- Can perform cryptographic operations itself.

Keys never leave KMS

- KMS can create keys, manage keys, import keys and these keys can be used to perform operations
- But keys are locked inside KMS
- Primary function of KMS is that keys never leave KMS

KMS provides `FIPS 140-2 (L2)` complaint service.

- Some features are level 3 complaint as well

---

## Customer Master Keys (CMK)

CMK's are containers for the actual `physical` master key.

It is logical and contains

- ID
- Date
- Policy
- Description
- State

Every CMK is backed by physical key material

- This physical key material is held by KMS and is used for encryption and decryption
- This physical key material can be generated by KMS
- Or imported into KMS

This physical key material can be used to encrypt or decrypt data thats upto `4KB` in size.

### Types of CMK

- AWS Managed
- Customer Managed CMK

### Key Concepts

- CMK's are isolated to a region and never leave that region. They also never leave KMS.
- You cannot extract a CMK.
- CMK's are configurable. You can allow other AWS accounts to access this.
- Both AWS and Customer Managed CMK's support key rotation.
  - During the key rotation the physical key material used for encryption is changed.
- AWS managed keys are always rotated. This feature can't be disabled for AWS managed keys.
  - Keys are rotated every 1095 days(3 years)
- Customer Managed Keys support rotation.
  - Keys are rotated once a year

### Aliases

These can be used to specify the CMK. So the underlying CMK can be changed.

- Just like CMK, aliases are regional too.
- Every alias in each region has its associated CMK different from other regions.

---

## KMS and CMK

On `CreateKey` a CMK will be created in KMS. This key will be stored into KMS in an encrypted form.

During `Encrypt` we send the data to be encrypted. Also specifying the key to be used.

- If all permissions are met, KMS decrypts the CMK.
- Uses the CMK to encrypt the plain text data.
- Returns the encrypted data.

During `Decrypt` we send the encrypted data to KMS

- Key to be used doesnt have to be specifed
- KMS gets this information from the cyphertext encoded into the encrypted data
- If permissions are met, KMS will decrypt the CMK and uses that to decrypt the encrypted data

CreateKey, Encrypt and Decrypt are individual operations and require their own permissions.

## Data Encryption Key (DEK)

### Why to use DEK

CMK will be used to create encrypted DEK. This process of encrypting one key with another is called envelope encryption.

Now encrytped DEK and encrypted object is stored without the need of storing the plaintext DEK.

So even if someone gained access to encrypted DEK and encrypted object, they will not be able to perform decryption as the CMK was used to encrypt DEK. And CMK is stored in KMS.

### GenerateDataKey

Using the GenerateDataKey operation will indicate KMS which CMK to be used, which will be used to generate Data Encryption Key.

- Data Encryption Key can be used to overcome the 4KB limit over data to be encrypted
- DEK can be linked to a specific CMK that was used to create the DEK

When a DEK is generated, KMS returns the key in two forms:

- Plain text
- Encrypted

### Encyption Process

You use the plain text version of the DEK to encrypt the data. Once done, you discard the plain text DEK.

- KMS doesnt perform encryption on data larger than 4KB using the DEK
- This operation is to be done by customer or the service using the DEK
- KMS doesnt track the DEK usage
- So we can use the same DEK to encrypt multiple files or request one for each file

### Decryption Process

You pass the DEK back to KMS and you ask it to decrypt it using the CMK that was used to generate the DEK.

- Use the plain text DEK returned by KMS
- Decrypt the encrypted file
- Discard the plain text DEK

### Storage of DEK

KMS does not store DEK in any form

- Its returns the DEK to the service requesting the key and then discards it
- Key is discarded as KMS doesn't perform encryption or decryption of data using DEK

### S3

S3 uses DEK for every object that is encrypted in it.

- It encrypts the object using plain text DEK and then only stores the encrypted version of DEK

---

## Key Policies and Security

Key Policy is the starting point for security on AWS.

- Its a `resource policy`, similar to bucket policy on S3 bucket, but on a key
- Every CMK has a key policy

Unlike other AWS services, KMS should be explicitly told the keys trust the AWS account they are in.

The following policy means that the key having the following key policy, will allow AWS account `111122223333` to manage it.

```json
{
  "Sid": "Enable IAM policies",
  "Effect": "Allow",
  "Principal": { "AWS": "arn:aws:iam::111122223333:root" },
  "Action": "kms:*",
  "Resource": "*"
}
```

You always need such key policies.

- The key trusts the account
- So the account can manage it by applying IAM permissions policy to the IAM users in that account

So, in order for IAM to work.

- IAM is trusted by the account
- The account must be trusted by the key

Chain of trust:

> key -> account -> IAM -> IAM user

### IAM Policy

The following gives the holder of the policy the rights to use the key to Encrypt or Decrypt the data.

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": ["kms:Encrypt", "kms:Decrypt"],
    "Resource": "arn:aws:iam:*:111122223333:key/*"
  }
}
```

These kinds of policy can be used to create groups of users. Say, you create groups of user:

- who can create and manage the keys but not use them
- users who can only use the keys
